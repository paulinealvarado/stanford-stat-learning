---
title: "LAB: Logistic Regression, LDA, QDA and KNN"
output: pdf_document
---

This exercise comes from Statistcal Learning in R certificate course from Stanford University online. Code tutorial taken from An Introduction to Statistical Learning with Applications in R (James, Witten, Hastie, and Tibshirani).

# Stock Market Data
Percetange returns for S&P 5000 stock index over 1,250 (2001-2005). Each date, recorded percentage returns of the five previous trading days (Lag1-Lag5). Recorded Volume (number of shares traded on previous day, in billions), Today (percentage return on that date), Direction (market Up or Down)

## Load and View Data
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(ISLR)
names(Smarket)

```

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

summary(Smarket)

```

# Correlation 
Creates matrix containing all pairwise correlation among predictors in data set.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

cor(Smarket) #error because Direction variable is qualitative

```

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

cor(Smarket[,-9]) #remove Direction column

```

## Plotting substantial correlations
No correlation between Today and Lag1-Lag5. Substantial correlation between Year and Volume. Plot show that Volume increases over Time, i.e. average number of shares traded daily increased from 2001-2005.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

plot(Smarket$Volume)

```


#Logistic Regression
## Plotting two-class variable for each class
Not much correlation happening since stock market not easy to predict.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

pairs(Smarket,col=Smarket$Direction)

```

## Fit Generalized Linear Model to Run Logistic Regression
Use family=binomial to indicate logistic regression. Predict Direction using Lag1-Lag5 and Volume.
Findings: None of the coefficients are significant. Smallest p-value out of all variables is Lag1, but still indicates no clear evidence of association.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

glm.fits = glm(Direction ~ Lag1 + Lag2 + Lag3 + Lag4 + Lag5 + Volume, data = Smarket, family = binomial)
summary(glm.fits)

```

## Prediction
### Predict the probability that market will go up, given the predictors.
All close to 50% so no strong predictions
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

glm.probs = predict(glm.fits,type = "response") #output probability in P(Y = 1|X)
glm.probs[1:10] #print first 10 probabilities

```

### View dummy variable values
Down = 0
Up = 1
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

contrasts(Smarket$Direction)

```

### Convert Probabilities Into Class Labels
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

glm.pred = rep("Down", 1250) # create vector of 1250 Down element
glm.pred[glm.probs > .5] = "Up" # label "Up" for probabilities greater than 5 
```

### Confusion Matrix
Determine how many observations were correctly or incorrectly classified.
Results: Correctly predicted market go up 507 days and go down 145 days.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

table(glm.pred, Smarket$Direction)

```

## Error Rates
### Training Error Rate
Compute fraction of days where prediction was correct.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

mean(glm.pred == Smarket$Direction)
```

Training error rate underestimates training test error rate
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

100-52.16

```

### Better assessment of test error rate
Fit model using part of the data and examine who well it predicts held out data. Realistic error rate to predict Direction probability of future data for which market movements are unknown.


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Create Boolean vector for 2001-2004
train = (Smarket$Year < 2005)

# Use vector to create 2005 dataset
Smarket.2005 = Smarket[!train,]
dim(Smarket.2005)
Direction.2005 = Smarket$Direction[!train]
```


## Refit logistic regression
Remove variables with no relationship with response because it deteriorates test rate (increase variance without decrease in bias). Only use Lag1 and Lag2 because they have the "best" p-values.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

glm.fits = glm(Direction ~ Lag1 + Lag2, data = Smarket, family = binomial, subset = train)
glm.probs = predict(glm.fits, Smarket.2005, type = "response")
glm.pred = rep("Down", 252)
glm.pred[glm.probs > .5] = "Up"
table(glm.pred, Direction.2005) # On days when model predict increase in market, 58% accuracy

mean(glm.pred == Direction.2005) # 56% correctly predicted

106/(106+76)
```

# Linear Discriminant Analysis

## Fit the model using observations from 2001-2004  

Results  
Probability: 49.2% of market going down
Group means: previous 2 days' returns negative when market increases; previous day return are positive when market declines
Coefficients: Forms LDA decision rule. If -0.642Lag1 - 0.514Lag2 is large, then LDA classifier predicts market increase. If small, then market decline.
 
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(MASS)

lda.fit = lda(Direction ~ Lag1 + Lag2, data = Smarket, subset = train) # function idential to lm()
lda.fit

plot(lda.fit)
```

## Prediction

predict() returns class (LDA prediction), posterior (kth column contain posterior prob), x (linear discriminants)
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

lda.pred = predict(lda.fit, Smarket.2005)
names(lda.pred)

```

LDA and logistic regressions predictions almost identical
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

lda.class = lda.pred$class
table(lda.class, Direction.2005)

mean(lda.class == Direction.2005)
```

50% threshold to posterior probabilities recreates predictions in lda.pred$class
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

sum(lda.pred$posterior[,1]>=.5)
sum(lda.pred$posterior[,1]<.5)


```

Posterior probability output by the model corresponds to the probability that the market will decrease
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

lda.pred$posterior [1:20,1]
lda.class [1:20]

```

example: Predict market decrease if posterior probability is >=90%. No returns because no day in 2005 meet that thresshold. Greatest porbability of market decrease in all of 2005 is 52.2%.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

sum(lda.pred$posterior[,1]>.9)

```


# Quadratic Discriminant Analysis

##Fit model.
Similar syntax to lda(). Output contains group means, but not coefficients. 
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

qda.fit = qda(Direction ~ Lag1 + Lag2, data = Smarket, subset = train)
qda.fit

```

# Predict
Output indicates that QDA prediction have 60% accuracy, which may be better than LDA and logistic. Need to evaluate performance on larger test set.
```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

qda.class = predict(qda.fit, Smarket.2005)$class
table(qda.class, Direction.2005)
mean(qda.class == Direction.2005)

```

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

```


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

```


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

```

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

```


```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

```



